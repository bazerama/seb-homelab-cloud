name: OpenTofu CI/CD

on:
  push:
    branches:
      - main
    paths:
      - '**.tf'
      - '**.tpl'
      - '.github/workflows/opentofu.yml'
  pull_request:
    branches:
      - main
    paths:
      - '**.tf'
      - '**.tpl'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

env:
  TF_VAR_tenancy_ocid: ${{ secrets.OCI_TENANCY_OCID }}
  TF_VAR_user_ocid: ${{ secrets.OCI_USER_OCID }}
  TF_VAR_fingerprint: ${{ secrets.OCI_FINGERPRINT }}
  TF_VAR_compartment_ocid: ${{ secrets.OCI_COMPARTMENT_OCID }}
  TF_VAR_region: ${{ secrets.OCI_REGION }}
  TF_VAR_availability_domain: ${{ secrets.OCI_AVAILABILITY_DOMAIN }}
  TF_VAR_arm_image_ocid: ${{ secrets.OCI_ARM_IMAGE_OCID }}
  TF_VAR_billing_alert_email: ${{ secrets.OCI_BILLING_ALERT_EMAIL }}
  # S3-compatible credentials for OCI Object Storage remote state
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.6.0

      - name: Format check
        id: fmt
        run: tofu fmt -check -recursive
        continue-on-error: true

      - name: Initialize OpenTofu
        id: init
        run: tofu init

      - name: Validate configuration
        id: validate
        run: tofu validate -no-color

      - name: Comment on PR - Format
        if: github.event_name == 'pull_request' && steps.fmt.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **OpenTofu Format Check Failed**\n\nPlease run `tofu fmt -recursive` to format your code.'
            })

  plan:
    name: Plan
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.6.0

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/id_rsa.pub
          chmod 600 ~/.ssh/id_rsa.pub

      - name: Setup OCI credentials
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          echo "TF_VAR_private_key_path=$HOME/.oci/oci_api_key.pem" >> $GITHUB_ENV
          echo "TF_VAR_ssh_public_key_path=$HOME/.ssh/id_rsa.pub" >> $GITHUB_ENV

      - name: Initialize OpenTofu
        run: tofu init

      - name: Plan infrastructure changes
        id: plan
        run: |
          tofu plan -no-color -out=tfplan
          tofu show -no-color tfplan > plan_output.txt
        continue-on-error: true

      - name: Upload plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: tfplan
          retention-days: 7

      - name: Comment PR with plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('plan_output.txt', 'utf8');
            const truncatedPlan = plan.length > 65000 ? plan.substring(0, 65000) + '\n\n... (truncated)' : plan;

            // Delete previous plan comments from this workflow
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            for (const comment of comments.data) {
              if (comment.user.type === 'Bot' && comment.body.includes('#### OpenTofu Plan')) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                });
              }
            }

            // Post new plan comment
            const output = `#### OpenTofu Plan üìù

            <details><summary>Show Plan</summary>

            \`\`\`hcl
            ${truncatedPlan}
            \`\`\`

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  apply:
    name: Apply
    needs: validate
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
    environment:
      name: production
      url: https://cloud.oracle.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.6.0

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/id_rsa.pub
          chmod 600 ~/.ssh/id_rsa.pub

      - name: Setup OCI credentials
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          echo "TF_VAR_private_key_path=$HOME/.oci/oci_api_key.pem" >> $GITHUB_ENV
          echo "TF_VAR_ssh_public_key_path=$HOME/.ssh/id_rsa.pub" >> $GITHUB_ENV

      - name: Initialize OpenTofu
        run: tofu init

      - name: Apply infrastructure changes (with retry)
        id: apply
        run: |
          MAX_ATTEMPTS=5
          ATTEMPT=1
          DELAY=60
          OUTPUT_FILE=$(mktemp)

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "üöÄ Attempt $ATTEMPT of $MAX_ATTEMPTS..."

            # Capture both stdout and stderr
            if tofu apply -auto-approve 2>&1 | tee "$OUTPUT_FILE"; then
              echo "‚úÖ Apply succeeded!"
              rm -f "$OUTPUT_FILE"
              exit 0
            fi

            EXIT_CODE=$?

            # Check if the error is a capacity issue that we should retry
            if grep -q "Out of host capacity" "$OUTPUT_FILE"; then
              SHOULD_RETRY=true
              ERROR_TYPE="capacity"
            elif grep -q "LimitExceeded" "$OUTPUT_FILE"; then
              SHOULD_RETRY=false
              ERROR_TYPE="limit-exceeded"
            elif grep -q "already exist" "$OUTPUT_FILE"; then
              SHOULD_RETRY=false
              ERROR_TYPE="duplicate-resource"
            else
              SHOULD_RETRY=false
              ERROR_TYPE="unknown"
            fi

            if [ "$SHOULD_RETRY" = true ] && [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "‚ö†Ô∏è  Capacity issue detected (exit code: $EXIT_CODE)"
              echo "üí§ Waiting ${DELAY}s before retry..."
              echo "üìä This is common in Sydney region - ARM capacity is limited"
              sleep $DELAY

              # Exponential backoff: 60s, 120s, 240s, 480s
              DELAY=$((DELAY * 2))
              ATTEMPT=$((ATTEMPT + 1))
            else
              if [ "$SHOULD_RETRY" = false ]; then
                echo "‚ùå Non-retryable error detected: $ERROR_TYPE"
                echo "üìã This error requires manual intervention - retrying won't help"

                if [ "$ERROR_TYPE" = "limit-exceeded" ]; then
                  echo "‚ö†Ô∏è  LIMIT EXCEEDED: Check OCI console for existing resources"
                  echo "   - VCNs: https://cloud.oracle.com/networking/vcns"
                  echo "   - Budgets: https://cloud.oracle.com/usage/budgets"
                elif [ "$ERROR_TYPE" = "duplicate-resource" ]; then
                  echo "‚ö†Ô∏è  DUPLICATE RESOURCE: A resource with this name already exists"
                  echo "   Either import it into state or delete it from OCI console"
                fi
              else
                echo "‚ùå All $MAX_ATTEMPTS capacity retry attempts failed"
              fi

              rm -f "$OUTPUT_FILE"
              exit $EXIT_CODE
            fi
          done

          rm -f "$OUTPUT_FILE"

      - name: Comment on capacity retry (if applicable)
        if: steps.apply.outcome == 'success' && github.event_name == 'push'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            // Find the most recent PR that was merged to trigger this workflow
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 5
            });

            const mergedPR = prs.data.find(pr =>
              pr.merged_at &&
              pr.merge_commit_sha === context.sha
            );

            if (mergedPR) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: mergedPR.number,
                body: `## ‚úÖ Deployment Successful!\n\nThe infrastructure has been deployed after handling OCI capacity constraints.\n\nüí° **Note**: Due to limited ARM capacity in Sydney, deployments may require multiple attempts. This is normal and expected.`
              });
            }

      - name: Output cluster information
        run: |
          echo "## üéâ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cluster Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          tofu output -json | jq -r 'to_entries[] | "- **\(.key)**: \(.value.value)"' >> $GITHUB_STEP_SUMMARY

  destroy:
    name: Destroy
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    environment:
      name: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.6.0

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/id_rsa.pub
          chmod 600 ~/.ssh/id_rsa.pub

      - name: Setup OCI credentials
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          echo "TF_VAR_private_key_path=$HOME/.oci/oci_api_key.pem" >> $GITHUB_ENV
          echo "TF_VAR_ssh_public_key_path=$HOME/.ssh/id_rsa.pub" >> $GITHUB_ENV

      - name: Initialize OpenTofu
        run: tofu init

      - name: Destroy infrastructure
        run: tofu destroy -auto-approve

      - name: Destruction summary
        run: |
          echo "## üí• Infrastructure Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All resources have been destroyed." >> $GITHUB_STEP_SUMMARY
